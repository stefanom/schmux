<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>schmux - Workspaces</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="app-shell">
        <!-- Header -->
        <header class="app-shell__header">
            <a href="/sessions" class="logo">schmux</a>
            <div class="header-actions">
                <div class="connection-pill connection-pill--connected" id="connectionPill">
                    <span class="connection-pill__dot"></span>
                    <span id="connectionText">Connected</span>
                </div>
                <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">
                    <span class="icon-theme"></span>
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="app-shell__nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/sessions" class="nav-link">
                        <svg class="nav-link__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                        </svg>
                        Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/workspaces" class="nav-link nav-link--active">
                        <svg class="nav-link__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Workspaces
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/spawn" class="nav-link">
                        <svg class="nav-link__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        Spawn
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="app-shell__content">
            <div class="page-header">
                <h1 class="page-header__title">Workspaces</h1>
                <div class="page-header__actions">
                    <button id="refreshBtn" class="btn btn--ghost">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Refresh
                    </button>
                    <a href="/spawn" class="btn btn--primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        Spawn
                    </a>
                </div>
            </div>

            <!-- Workspace Controls -->
            <div class="workspace-controls">
                <button class="btn btn--sm btn--ghost" onclick="expandAll()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    Expand All
                </button>
                <button class="btn btn--sm btn--ghost" onclick="collapseAll()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                    Collapse All
                </button>
            </div>

            <!-- Workspaces Container -->
            <div id="workspacesContainer" class="workspace-list"></div>
        </main>
    </div>

    <script src="/app.js"></script>
    <script>
        // DOM Elements
        const workspacesContainer = document.getElementById('workspacesContainer');
        const refreshBtn = document.getElementById('refreshBtn');

        // State
        let allWorkspaces = [];
        let sessionsByWorkspace = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkspaces();

            refreshBtn.addEventListener('click', loadWorkspaces);
        });

        async function loadWorkspaces() {
            try {
                const workspaces = await API.getWorkspaces();
                allWorkspaces = workspaces;

                // Also load sessions to get counts
                const sessions = await API.getSessions();
                sessionsByWorkspace = {};
                sessions.forEach(ws => {
                    sessionsByWorkspace[ws.id] = ws.sessions;
                });

                renderWorkspaces();
            } catch (error) {
                workspacesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state__icon">⚠️</div>
                        <h3 class="empty-state__title">Failed to load workspaces</h3>
                        <p class="empty-state__description">${error.message}</p>
                        <button class="btn btn--primary" onclick="loadWorkspaces()">Try Again</button>
                    </div>
                `;
            }
        }

        function renderWorkspaces() {
            if (allWorkspaces.length === 0) {
                workspacesContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 class="empty-state__title">No workspaces found</h3>
                        <p class="empty-state__description">Workspaces will appear here when you spawn sessions</p>
                        <a href="/spawn" class="btn btn--primary">Spawn Sessions</a>
                    </div>
                `;
                return;
            }

            workspacesContainer.innerHTML = allWorkspaces.map(ws => renderWorkspace(ws)).join('');
        }

        function renderWorkspace(ws) {
            const sessions = sessionsByWorkspace[ws.id] || [];
            const sessionCount = sessions.length;

            // Extract repo name from URL for display
            const repoName = ws.repo.split('/').pop().replace('.git', '');

            const sessionsHtml = sessions.map(sess => renderSession(sess)).join('');

            return `
                <div class="workspace-item" data-workspace-id="${ws.id}">
                    <div class="workspace-item__header" onclick="toggleWorkspace('${ws.id}')">
                        <div class="workspace-item__info">
                            <span class="workspace-item__toggle" id="toggle-${ws.id}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                            <span class="workspace-item__name">${Utils.escapeHtml(ws.id)}</span>
                            <span class="workspace-item__meta">${repoName} · ${Utils.escapeHtml(ws.branch)}</span>
                            <span class="badge badge--neutral">${sessionCount} session${sessionCount !== 1 ? 's' : ''}</span>
                        </div>
                        <button class="btn btn--sm" onclick="event.stopPropagation(); spawnInWorkspace('${ws.id}', '${Utils.escapeHtml(ws.repo)}', '${Utils.escapeHtml(ws.branch)}')" aria-label="Add agent to ${ws.id}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                            Add Agent
                        </button>
                    </div>
                    <div class="workspace-item__sessions" id="sessions-${ws.id}">
                        ${sessionCount > 0 ? `
                        <table class="session-table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessionsHtml}
                            </tbody>
                        </table>
                        ` : '<p style="padding: 1rem; color: var(--color-text-subtle);">No sessions in this workspace</p>'}
                    </div>
                </div>
            `;
        }

        function renderSession(sess) {
            const statusClass = sess.running ? 'status-pill--running' : 'status-pill--stopped';
            const statusText = sess.running ? 'Running' : 'Stopped';
            const createdTime = Utils.formatRelativeTime(sess.created_at);

            return `
                <tr class="session-row">
                    <td>
                        <span style="font-weight: 500;">${Utils.escapeHtml(sess.agent)}</span>
                        <div style="font-size: 0.75rem; color: var(--color-text-subtle);">${Utils.escapeHtml(sess.id)}</div>
                    </td>
                    <td>
                        <span class="status-pill ${statusClass}">
                            <span class="status-pill__dot"></span>
                            ${statusText}
                        </span>
                    </td>
                    <td>${createdTime}</td>
                    <td>
                        <div class="session-table__actions">
                            <button class="btn btn--sm btn--ghost" onclick="viewSession('${sess.id}')" title="View session" aria-label="View ${sess.id}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            <button class="btn btn--sm btn--ghost" onclick="copyAttachCommand('${Utils.escapeHtml(sess.attach_cmd)}')" title="Copy attach command" aria-label="Copy attach command">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button class="btn btn--sm btn--ghost btn--danger" onclick="disposeSession('${sess.id}')" title="Dispose session" aria-label="Dispose ${sess.id}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function toggleWorkspace(workspaceId) {
            const sessionsDiv = document.getElementById(`sessions-${workspaceId}`);
            const toggle = document.getElementById(`toggle-${workspaceId}`);

            if (sessionsDiv.classList.contains('workspace-item__sessions--expanded')) {
                sessionsDiv.classList.remove('workspace-item__sessions--expanded');
                toggle.classList.add('workspace-item__toggle--collapsed');
            } else {
                sessionsDiv.classList.add('workspace-item__sessions--expanded');
                toggle.classList.remove('workspace-item__toggle--collapsed');
            }
        }

        function expandAll() {
            document.querySelectorAll('.workspace-item__sessions').forEach(div => {
                div.classList.add('workspace-item__sessions--expanded');
            });
            document.querySelectorAll('.workspace-item__toggle').forEach(toggle => {
                toggle.classList.remove('workspace-item__toggle--collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.workspace-item__sessions').forEach(div => {
                div.classList.remove('workspace-item__sessions--expanded');
            });
            document.querySelectorAll('.workspace-item__toggle').forEach(toggle => {
                toggle.classList.add('workspace-item__toggle--collapsed');
            });
        }

        function spawnInWorkspace(workspaceId, repo, branch) {
            window.location.href = `/spawn?workspace_id=${workspaceId}`;
        }

        function viewSession(sessionId) {
            window.location.href = `/sessions/${sessionId}`;
        }

        async function copyAttachCommand(command) {
            await Utils.copyToClipboard(command);
            Toast.success('Copied attach command');
        }

        async function disposeSession(sessionId) {
            Modal.confirm(
                `Dispose session ${sessionId}?`,
                async () => {
                    try {
                        await API.disposeSession(sessionId);
                        Toast.success('Session disposed');
                        loadWorkspaces();
                    } catch (error) {
                        Toast.error(`Failed to dispose: ${error.message}`);
                    }
                }
            );
        }
    </script>
</body>
</html>

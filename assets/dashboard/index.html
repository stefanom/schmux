<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>schmux - Sessions</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .workspace-group {
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .workspace-header {
            background: var(--header-bg);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .workspace-header:hover {
            background: var(--hover-bg);
        }
        .workspace-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .workspace-toggle {
            font-size: 1.2rem;
            transition: transform 0.2s;
        }
        .workspace-toggle.collapsed {
            transform: rotate(-90deg);
        }
        .workspace-name {
            font-weight: bold;
        }
        .workspace-meta {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .workspace-sessions {
            display: none;
        }
        .workspace-sessions.expanded {
            display: block;
        }
        .session-count-badge {
            background: var(--accent-color);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>schmux</h1>
            <div class="header-actions">
                <button id="themeToggle" class="btn-icon" title="Toggle theme">
                    <span class="icon-sun"></span>
                </button>
                <a href="/spawn" class="btn">Spawn Sessions</a>
                <button id="refreshBtn" class="btn">Refresh</button>
            </div>
        </header>

        <main>
            <section class="sessions-section">
                <h2>Workspaces</h2>
                <div id="statusMessage" class="toast-notification" style="display: none;"></div>
                <div id="workspacesContainer">
                    <div class="loading">Loading workspaces...</div>
                </div>
            </section>
        </main>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3 id="confirmTitle">Confirm Action</h3>
                <p id="confirmMessage">Are you sure?</p>
                <div class="modal-actions">
                    <button id="confirmCancel" class="btn">Cancel</button>
                    <button id="confirmOk" class="btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        let statusTimeout;

        function showStatus(message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.classList.add('show');

            clearTimeout(statusTimeout);
            statusTimeout = setTimeout(() => {
                statusEl.classList.remove('show');
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 300);
            }, 3000);
        }

        let confirmCallback = null;

        function showConfirm(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmTitle').textContent = 'Confirm Action';

            confirmCallback = onConfirm;
            modal.style.display = 'flex';
        }

        document.getElementById('confirmCancel').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        });

        document.getElementById('confirmOk').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        });

        // Load workspaces on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkspaces();
        });

        // Refresh button handler
        document.getElementById('refreshBtn').addEventListener('click', loadWorkspaces);

        async function loadWorkspaces() {
            const container = document.getElementById('workspacesContainer');
            container.innerHTML = '<div class="loading">Loading workspaces...</div>';

            try {
                const response = await fetch('/api/sessions');
                const workspaces = await response.json();

                if (workspaces.length === 0) {
                    container.innerHTML = '<div class="empty">No active workspaces. <a href="/spawn">Spawn some</a></div>';
                    return;
                }

                container.innerHTML = workspaces.map(ws => renderWorkspace(ws)).join('');
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load workspaces: ${error.message}</div>`;
            }
        }

        function renderWorkspace(ws) {
            const sessionsHtml = ws.sessions.map(sess => {
                const statusClass = sess.running ? 'status-running' : 'status-stopped';
                const statusText = sess.running ? 'Running' : 'Stopped';
                const createdDate = new Date(sess.created_at).toLocaleString();

                return `
                    <tr class="session-row" data-workspace="${ws.id}">
                        <td class="monospace">${sess.agent}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>${createdDate}</td>
                        <td class="actions">
                            <button class="btn-small" onclick="copyAttachCommand('${sess.attach_cmd}')" title="Copy attach command">Copy</button>
                            <button class="btn-small" onclick="viewTerminal('${sess.id}')" title="View terminal">View</button>
                            <button class="btn-small btn-danger" onclick="disposeSession('${sess.id}')" title="Dispose session">Dispose</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="workspace-group" data-workspace-id="${ws.id}">
                    <div class="workspace-header" onclick="toggleWorkspace('${ws.id}')">
                        <div class="workspace-info">
                            <span class="workspace-toggle" id="toggle-${ws.id}">▼</span>
                            <span class="workspace-name">${ws.id}</span>
                            <span class="workspace-meta">${ws.repo} · ${ws.branch}</span>
                            <span class="session-count-badge">${ws.session_count} session${ws.session_count !== 1 ? 's' : ''}</span>
                        </div>
                        <button class="btn-small" onclick="event.stopPropagation(); spawnInWorkspace('${ws.id}', '${ws.repo}', '${ws.branch}')" title="Spawn in this directory">+ Add Agent</button>
                    </div>
                    <div class="workspace-sessions" id="sessions-${ws.id}">
                        <table class="sessions-table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessionsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function toggleWorkspace(workspaceId) {
            const sessionsDiv = document.getElementById(`sessions-${workspaceId}`);
            const toggle = document.getElementById(`toggle-${workspaceId}`);

            if (sessionsDiv.classList.contains('expanded')) {
                sessionsDiv.classList.remove('expanded');
                toggle.classList.add('collapsed');
            } else {
                sessionsDiv.classList.add('expanded');
                toggle.classList.remove('collapsed');
            }
        }

        function spawnInWorkspace(workspaceId, repo, branch) {
            // Open spawn page with workspace_id pre-filled
            window.location.href = `/spawn?workspace_id=${workspaceId}&repo=${encodeURIComponent(repo)}&branch=${encodeURIComponent(branch)}`;
        }

        function copyAttachCommand(command) {
            navigator.clipboard.writeText(command).then(() => {
                showStatus('Copied: ' + command);
            });
        }

        function viewTerminal(sessionId) {
            window.open(`/terminal.html?id=${sessionId}`, '_blank', 'width=800,height=600');
        }

        async function disposeSession(sessionId) {
            showConfirm(`Dispose session ${sessionId}? This will clean up the workspace.`, async () => {
                try {
                    const response = await fetch(`/api/dispose/${sessionId}`, { method: 'POST' });
                    if (!response.ok) {
                        throw new Error('Failed to dispose session');
                    }
                    showStatus('Session disposed');
                    loadWorkspaces();
                } catch (error) {
                    showStatus(`Failed to dispose session: ${error.message}`);
                }
            });
        }
    </script>
</body>
</html>

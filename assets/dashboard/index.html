<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>schmux - Sessions</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="app-shell">
        <!-- Header -->
        <header class="app-shell__header">
            <a href="/sessions" class="logo">schmux</a>
            <div class="header-actions">
                <div class="connection-pill connection-pill--connected" id="connectionPill">
                    <span class="connection-pill__dot"></span>
                    <span id="connectionText">Connected</span>
                </div>
                <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">
                    <span class="icon-theme"></span>
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="app-shell__nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="/sessions" class="nav-link nav-link--active">
                        <svg class="nav-link__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                        </svg>
                        Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/workspaces" class="nav-link">
                        <svg class="nav-link__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Workspaces
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/spawn" class="nav-link">
                        <svg class="nav-link__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        Spawn
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="app-shell__content">
            <div class="page-header">
                <h1 class="page-header__title">Sessions</h1>
                <div class="page-header__actions">
                    <button id="refreshBtn" class="btn btn--ghost">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Refresh
                    </button>
                    <a href="/spawn" class="btn btn--primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        Spawn
                    </a>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <span class="filter-bar__label">Filters:</span>
                <div class="filter-bar__filters">
                    <select id="statusFilter" class="select" aria-label="Filter by status">
                        <option value="">All Status</option>
                        <option value="running">Running</option>
                        <option value="stopped">Stopped</option>
                    </select>
                    <select id="repoFilter" class="select" aria-label="Filter by repository">
                        <option value="">All Repos</option>
                    </select>
                </div>
            </div>

            <!-- Workspace Controls -->
            <div class="workspace-controls">
                <button class="btn btn--sm btn--ghost" onclick="expandAll()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    Expand All
                </button>
                <button class="btn btn--sm btn--ghost" onclick="collapseAll()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                    Collapse All
                </button>
            </div>

            <!-- Workspaces Container -->
            <div id="workspacesContainer" class="workspace-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <span>Loading workspaces...</span>
                </div>
            </div>
        </main>
    </div>

    <script src="/app.js"></script>
    <script>
        // State
        let allWorkspaces = [];
        let filteredWorkspaces = [];
        let filters = {
            status: '',
            repo: ''
        };

        // DOM Elements
        const workspacesContainer = document.getElementById('workspacesContainer');
        const statusFilter = document.getElementById('statusFilter');
        const repoFilter = document.getElementById('repoFilter');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFiltersFromURL();
            loadWorkspaces();
            setupEventListeners();
        });

        function loadFiltersFromURL() {
            const params = new URLSearchParams(window.location.search);
            filters.status = params.get('s') || '';
            filters.repo = params.get('r') || '';

            // Update dropdowns to match URL
            if (filters.status) statusFilter.value = filters.status;
            if (filters.repo) repoFilter.value = filters.repo;
        }

        function updateURL() {
            const params = new URLSearchParams();
            if (filters.status) params.set('s', filters.status);
            if (filters.repo) params.set('r', filters.repo);

            const url = params.toString() ? '/sessions?' + params.toString() : '/sessions';
            window.history.replaceState({}, '', url);
        }

        function extractRepoName(repoUrl) {
            // Extract repo name from URL: "https://github.com/user/repo.git" -> "repo"
            return repoUrl.split('/').pop().replace('.git', '');
        }

        function setupEventListeners() {
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadWorkspaces();
            });

            // Filters
            statusFilter.addEventListener('change', (e) => {
                filters.status = e.target.value;
                updateURL();
                applyFilters();
            });

            repoFilter.addEventListener('change', (e) => {
                filters.repo = e.target.value;
                updateURL();
                applyFilters();
            });
        }

        async function loadWorkspaces() {
            workspacesContainer.innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <span>Loading workspaces...</span>
                </div>
            `;

            try {
                const workspaces = await API.getSessions();
                allWorkspaces = workspaces;

                // Populate repo filter with repo names (extracted from URLs)
                const repoNames = [...new Set(workspaces.map(ws => extractRepoName(ws.repo)))].sort();
                repoFilter.innerHTML = '<option value="">All Repos</option>' +
                    repoNames.map(name => `<option value="${name}">${name}</option>`).join('');

                applyFilters();
            } catch (error) {
                workspacesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state__icon">⚠️</div>
                        <h3 class="empty-state__title">Failed to load workspaces</h3>
                        <p class="empty-state__description">${error.message}</p>
                        <button class="btn btn--primary" onclick="loadWorkspaces()">Try Again</button>
                    </div>
                `;
            }
        }

        function applyFilters() {
            filteredWorkspaces = allWorkspaces.filter(ws => {
                // Status filter
                if (filters.status) {
                    const hasMatchingSession = ws.sessions.some(s =>
                        filters.status === 'running' ? s.running : !s.running
                    );
                    if (!hasMatchingSession) return false;
                }

                // Repo filter (compare by repo name, not URL)
                if (filters.repo && extractRepoName(ws.repo) !== filters.repo) {
                    return false;
                }

                return true;
            });

            renderWorkspaces();
        }

        function renderWorkspaces() {
            if (filteredWorkspaces.length === 0) {
                workspacesContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 class="empty-state__title">No sessions found</h3>
                        <p class="empty-state__description">
                            ${Object.values(filters).some(v => v) ? 'Try adjusting your filters' : 'Get started by spawning your first sessions'}
                        </p>
                        ${!Object.values(filters).some(v => v) ? '<a href="/spawn" class="btn btn--primary">Spawn Sessions</a>' : ''}
                    </div>
                `;
                return;
            }

            workspacesContainer.innerHTML = filteredWorkspaces.map(ws => renderWorkspace(ws)).join('');
        }

        function renderWorkspace(ws) {
            // Filter sessions based on current filters
            let sessions = ws.sessions;

            if (filters.status) {
                sessions = sessions.filter(s =>
                    filters.status === 'running' ? s.running : !s.running
                );
            }

            const sessionsHtml = sessions.map(sess => renderSession(sess, ws)).join('');

            return `
                <div class="workspace-item" data-workspace-id="${ws.id}">
                    <div class="workspace-item__header" onclick="toggleWorkspace('${ws.id}')">
                        <div class="workspace-item__info">
                            <span class="workspace-item__toggle" id="toggle-${ws.id}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                            <span class="workspace-item__name">${Utils.escapeHtml(ws.id)}</span>
                            <span class="workspace-item__meta">${Utils.escapeHtml(ws.repo)} · ${Utils.escapeHtml(ws.branch)}</span>
                            <span class="badge badge--neutral">${ws.session_count} session${ws.session_count !== 1 ? 's' : ''}</span>
                        </div>
                        <button class="btn btn--sm" onclick="event.stopPropagation(); spawnInWorkspace('${ws.id}', '${Utils.escapeHtml(ws.repo)}', '${Utils.escapeHtml(ws.branch)}')" aria-label="Spawn in ${ws.id}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                            Add Agent
                        </button>
                    </div>
                    <div class="workspace-item__sessions" id="sessions-${ws.id}">
                        <table class="session-table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessionsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderSession(sess, ws) {
            const statusClass = sess.running ? 'status-pill--running' : 'status-pill--stopped';
            const statusText = sess.running ? 'Running' : 'Stopped';
            const createdTime = Utils.formatRelativeTime(sess.created_at);

            return `
                <tr class="session-row">
                    <td><span class="mono">${Utils.escapeHtml(sess.agent)}</span></td>
                    <td>
                        <span class="status-pill ${statusClass}">
                            <span class="status-pill__dot"></span>
                            ${statusText}
                        </span>
                    </td>
                    <td>${createdTime}</td>
                    <td>
                        <div class="session-table__actions">
                            <button class="btn btn--sm btn--ghost" onclick="viewSession('${sess.id}')" title="View session" aria-label="View ${sess.id}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            <button class="btn btn--sm btn--ghost" onclick="copyAttachCommand('${Utils.escapeHtml(sess.attach_cmd)}')" title="Copy attach command" aria-label="Copy attach command">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button class="btn btn--sm btn--ghost btn--danger" onclick="disposeSession('${sess.id}')" title="Dispose session" aria-label="Dispose ${sess.id}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function toggleWorkspace(workspaceId) {
            const sessionsDiv = document.getElementById(`sessions-${workspaceId}`);
            const toggle = document.getElementById(`toggle-${workspaceId}`);

            if (sessionsDiv.classList.contains('workspace-item__sessions--expanded')) {
                sessionsDiv.classList.remove('workspace-item__sessions--expanded');
                toggle.classList.add('workspace-item__toggle--collapsed');
            } else {
                sessionsDiv.classList.add('workspace-item__sessions--expanded');
                toggle.classList.remove('workspace-item__toggle--collapsed');
            }
        }

        function expandAll() {
            document.querySelectorAll('.workspace-item__sessions').forEach(div => {
                div.classList.add('workspace-item__sessions--expanded');
            });
            document.querySelectorAll('.workspace-item__toggle').forEach(toggle => {
                toggle.classList.remove('workspace-item__toggle--collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.workspace-item__sessions').forEach(div => {
                div.classList.remove('workspace-item__sessions--expanded');
            });
            document.querySelectorAll('.workspace-item__toggle').forEach(toggle => {
                toggle.classList.add('workspace-item__toggle--collapsed');
            });
        }

        function spawnInWorkspace(workspaceId, repo, branch) {
            window.location.href = `/spawn?workspace_id=${workspaceId}`;
        }

        function viewSession(sessionId) {
            window.location.href = `/sessions/${sessionId}`;
        }

        async function copyAttachCommand(command) {
            await Utils.copyToClipboard(command);
        }

        async function disposeSession(sessionId) {
            Modal.confirm(
                `Dispose session ${sessionId}?`,
                async () => {
                    try {
                        await API.disposeSession(sessionId);
                        Toast.success('Session disposed');
                        loadWorkspaces();
                    } catch (error) {
                        Toast.error(`Failed to dispose: ${error.message}`);
                    }
                },
                { danger: true }
            );
        }
    </script>
</body>
</html>
